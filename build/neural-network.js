/// <reference path="./all.d.ts" />
var nervous_array_1 = require('nervous-array');
var nervous_sigmoid_1 = require('nervous-sigmoid');
var layer_1 = require('./layer');
var cost_1 = require('./cost');
require('./polyfills/assign');
var NeuralNetwork = (function () {
    function NeuralNetwork(config) {
        this.config = config;
        this.config.hiddenLayers = ((typeof this.config.hiddenLayers === 'number') ? [this.config.hiddenLayers] : this.config.hiddenLayers);
        this.config.trainingOptions = this.config.trainingOptions || {};
        this.config.trainingOptions.iterations = this.config.trainingOptions.iterations || 10000;
        this.config.trainingOptions.batchSize = this.config.trainingOptions.batchSize || 10;
        this.config.trainingOptions.regularization = (this.config.trainingOptions.regularization === undefined) ? 0.0001 : this.config.trainingOptions.regularization;
        this.config.trainingOptions.learningRate = (this.config.trainingOptions.learningRate === undefined) ? 0.5 : this.config.trainingOptions.learningRate;
        this.activationFunctions = {
            activation: nervous_sigmoid_1.sigmoid,
            activationPrime: nervous_sigmoid_1.sigmoidPrime
        };
        switch (this.config.costStrategy) {
            case cost_1.ECostStrategy.Quadratic:
            default:
                this.costStrategy = new cost_1.QuadraticCost(this.activationFunctions);
                break;
            case cost_1.ECostStrategy.CrossEntropy:
                this.costStrategy = new cost_1.CrossEntropyCost(this.activationFunctions);
                break;
        }
        this.neuronsLayers = [];
        this.synapsesLayers = [];
        this.numberOfSynapses = 0;
        //layers creation
        this.neuronsLayers.push(this.inputLayer = new layer_1.InputLayer(config.inputLayerSize));
        for (var i = 0; i < config.hiddenLayers.length; i++) {
            this.neuronsLayers.push(new layer_1.HiddenLayer(config.hiddenLayers[i]));
        }
        this.neuronsLayers.push(this.outputLayer = new layer_1.OutputLayer(config.outputLayerSize));
        //synapses creation
        for (var j = 0; j < this.neuronsLayers.length - 1; j++) {
            var synapses = this.neuronsLayers[j].linkTo(this.neuronsLayers[j + 1]);
            this.synapsesLayers.push(synapses);
            this.numberOfSynapses += synapses.length;
        }
    }
    Object.defineProperty(NeuralNetwork.prototype, "weights", {
        get: function () {
            var weights = [];
            this.forEachSynapse(function (s) {
                weights.push(s.weight);
            });
            return weights;
        },
        set: function (synapses) {
            if (synapses.length !== this.numberOfSynapses) {
                throw new Error("The number of synapses differs.");
            }
            var cpt = 0;
            this.forEachSynapse(function (s) {
                s.weight = synapses[cpt++];
            });
        },
        enumerable: true,
        configurable: true
    });
    NeuralNetwork.prototype.getGradients = function (data) {
        var gradients = [];
        this.backward(data);
        this.forEachSynapse(function (s) {
            gradients.push(s.gradient);
        });
        return gradients;
    };
    NeuralNetwork.prototype.forEachSynapse = function (func) {
        for (var i = 0; i < this.synapsesLayers.length; i++) {
            for (var j = 0; j < this.synapsesLayers[i].length; j++) {
                func(this.synapsesLayers[i][j], i, j);
            }
        }
    };
    NeuralNetwork.prototype.forward = function (data) {
        var ret = [];
        for (var k = 0; k < data.length; k++) {
            //set input to input layer neurons
            this.inputLayer.neuronsValue = data[k].input;
            //propagate on each hidden layer and output
            for (var i = 1; i < this.neuronsLayers.length; i++) {
                this.neuronsLayers[i].activate(this.activationFunctions);
            }
            //retrieve output neuron value
            ret.push(this.outputLayer.neuronsValue);
            if (this.config.trainingOptions.log && k % 2 === 0) {
                console.info("Forward Progress " + k / data.length);
            }
        }
        return ret;
    };
    NeuralNetwork.prototype.cost = function (data) {
        var yHats = this.forward(data), j = 0, weightsSum = 0;
        for (var k = 0; k < data.length; k++) {
            j += this.costStrategy.fn(data[k].output, yHats[k]);
        }
        j = j / data.length;
        this.forEachSynapse(function (s) {
            weightsSum += Math.pow(s.weight, 2);
        });
        j += this.config.trainingOptions.regularization / (2 * data.length) * weightsSum;
        return j;
    };
    NeuralNetwork.prototype.backward = function (data) {
        var ret = [];
        for (var k = 0; k < data.length; k++) {
            var tuple = data[k], yHat = this.forward([tuple])[0];
            //set the input and output layer value
            this.inputLayer.neuronsValue = tuple.input;
            this.outputLayer.neuronsValue = nervous_array_1.sub(yHat, tuple.output);
            //compute propagation errors for all layers expect input
            for (var i = this.neuronsLayers.length - 1; i >= 1; i--) {
                this.neuronsLayers[i].computeErrors(this.costStrategy);
            }
            //compute dJdW for all synapses layer
            for (var i = 0; i < this.neuronsLayers.length; i++) {
                this.neuronsLayers[i].computeGradients();
            }
            if (this.config.trainingOptions.log && k % 2 === 0) {
                console.info("Backward Progress " + k / data.length);
            }
        }
        return this.synapsesLayers;
    };
    NeuralNetwork.prototype.adjustWeights = function (synapses, batchSize, dataSize) {
        var _this = this;
        if (synapses.length !== this.synapsesLayers.length) {
            throw new Error("The number of synapses layers differs.");
        }
        for (var i = 0; i < synapses.length; i++) {
            if (synapses[i].length !== this.synapsesLayers[i].length) {
                throw new Error("The number of synapses in the " + i + " layer differs");
            }
        }
        this.forEachSynapse(function (s) {
            s.weight = (1 - _this.config.trainingOptions.learningRate * _this.config.trainingOptions.regularization / dataSize) * s.weight - _this.config.trainingOptions.learningRate / batchSize * s.gradient;
            s.gradient = 0;
        });
    };
    NeuralNetwork.prototype.train = function (data, options) {
        Object.assign(this.config.trainingOptions, options);
        var iterations = this.config.trainingOptions.iterations, batchSize = this.config.trainingOptions.batchSize = (this.config.trainingOptions.batchSize > data.length) ? data.length : this.config.trainingOptions.batchSize;
        for (var i = 0; i < iterations; i++) {
            if (batchSize && batchSize !== data.length) {
                nervous_array_1.shuffle(data);
            }
            var batch = data.slice(0, batchSize), synapses = this.backward(batch);
            this.adjustWeights(synapses, batchSize, data.length);
            if (this.config.trainingOptions.log && i % 2 === 0) {
                console.info("Progress " + i / iterations + ", cost: " + this.cost(data));
            }
        }
        return {
            error: this.cost(data)
        };
    };
    return NeuralNetwork;
})();
exports.NeuralNetwork = NeuralNetwork;
function computeNumericalGradients(n, data) {
    var epsilon = 1e-4, initialWeights = n.weights, numGrads = initialWeights.length, gradients = nervous_array_1.zeros(numGrads), perturb = nervous_array_1.zeros(numGrads), k;
    for (k = 0; k < numGrads; k++) {
        var loss1 = void 0, loss2 = void 0;
        perturb[k] = epsilon;
        n.weights = nervous_array_1.add(initialWeights, perturb);
        loss2 = n.cost(data);
        n.weights = nervous_array_1.sub(initialWeights, perturb);
        loss1 = n.cost(data);
        gradients[k] = data.length * nervous_array_1.sum(nervous_array_1.multiplyByScalar(nervous_array_1.sub([loss2], [loss1]), 1 / (epsilon * 2)));
        perturb[k] = 0;
    }
    n.weights = initialWeights;
    return gradients;
}
exports.computeNumericalGradients = computeNumericalGradients;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5ldXJhbC1uZXR3b3JrLnRzIl0sIm5hbWVzIjpbIk5ldXJhbE5ldHdvcmsiLCJOZXVyYWxOZXR3b3JrLmNvbnN0cnVjdG9yIiwiTmV1cmFsTmV0d29yay53ZWlnaHRzIiwiTmV1cmFsTmV0d29yay5nZXRHcmFkaWVudHMiLCJOZXVyYWxOZXR3b3JrLmZvckVhY2hTeW5hcHNlIiwiTmV1cmFsTmV0d29yay5mb3J3YXJkIiwiTmV1cmFsTmV0d29yay5jb3N0IiwiTmV1cmFsTmV0d29yay5iYWNrd2FyZCIsIk5ldXJhbE5ldHdvcmsuYWRqdXN0V2VpZ2h0cyIsIk5ldXJhbE5ldHdvcmsudHJhaW4iLCJjb21wdXRlTnVtZXJpY2FsR3JhZGllbnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxtQ0FBbUM7QUFFbkMsOEJBQXlGLGVBQWUsQ0FBQyxDQUFBO0FBQ3pHLGdDQUFvQyxpQkFBaUIsQ0FBQyxDQUFBO0FBRXRELHNCQUEwRCxTQUFTLENBQUMsQ0FBQTtBQUVwRSxxQkFBMkUsUUFBUSxDQUFDLENBQUE7QUFFcEYsUUFBTyxvQkFBb0IsQ0FBQyxDQUFBO0FBZ0M1QjtJQVdFQSx1QkFDVUEsTUFBbUNBO1FBQW5DQyxXQUFNQSxHQUFOQSxNQUFNQSxDQUE2QkE7UUFHM0NBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLEdBQWFBLENBQUNBLENBQUNBLE9BQU9BLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLEtBQUtBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRTlJQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxJQUFJQSxFQUFFQSxDQUFDQTtRQUNoRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsVUFBVUEsSUFBSUEsS0FBS0EsQ0FBQ0E7UUFDekZBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLFNBQVNBLElBQUlBLEVBQUVBLENBQUNBO1FBQ3BGQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxjQUFjQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxjQUFjQSxLQUFLQSxTQUFTQSxDQUFDQSxHQUFHQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxjQUFjQSxDQUFDQTtRQUM5SkEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsWUFBWUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsWUFBWUEsS0FBS0EsU0FBU0EsQ0FBQ0EsR0FBR0EsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7UUFFckpBLElBQUlBLENBQUNBLG1CQUFtQkEsR0FBR0E7WUFDekJBLFVBQVVBLEVBQUVBLHlCQUFPQTtZQUNuQkEsZUFBZUEsRUFBRUEsOEJBQVlBO1NBQzlCQSxDQUFDQTtRQUVGQSxNQUFNQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQ0EsS0FBS0Esb0JBQWFBLENBQUNBLFNBQVNBLENBQUNBO1lBQzdCQTtnQkFDRUEsSUFBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsb0JBQWFBLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hFQSxLQUFLQSxDQUFDQTtZQUNSQSxLQUFLQSxvQkFBYUEsQ0FBQ0EsWUFBWUE7Z0JBQzdCQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSx1QkFBZ0JBLENBQUNBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0E7Z0JBQ25FQSxLQUFLQSxDQUFDQTtRQUNWQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDekJBLElBQUlBLENBQUNBLGdCQUFnQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFFMUJBLEFBQ0FBLGlCQURpQkE7UUFDakJBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLGtCQUFVQSxDQUFDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNqRkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBR0EsQ0FBQ0EsR0FBR0EsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsTUFBTUEsRUFBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDdERBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLG1CQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNuRUEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsbUJBQVdBLENBQUNBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLENBQUNBO1FBRXBGQSxBQUNBQSxtQkFEbUJBO1FBQ25CQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUN4REEsSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkVBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO1lBQ25DQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLElBQUlBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBO1FBQzNDQSxDQUFDQTtJQUVIQSxDQUFDQTtJQUVERCxzQkFBSUEsa0NBQU9BO2FBQVhBO1lBRUVFLElBQUlBLE9BQU9BLEdBQUdBLEVBQUVBLENBQUNBO1lBRWpCQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxVQUFDQSxDQUFDQTtnQkFDcEJBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQ3pCQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNIQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQTtRQUVqQkEsQ0FBQ0E7YUFDREYsVUFBYUEsUUFBa0JBO1lBRTdCRSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxLQUFLQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBLENBQUNBO2dCQUM5Q0EsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0EsaUNBQWlDQSxDQUFDQSxDQUFDQTtZQUNyREEsQ0FBQ0E7WUFFREEsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFFWkEsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBQ0EsQ0FBQ0E7Z0JBQ3BCQSxDQUFDQSxDQUFDQSxNQUFNQSxHQUFHQSxRQUFRQSxDQUFDQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQTtZQUM3QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFTEEsQ0FBQ0E7OztPQWJBRjtJQWVNQSxvQ0FBWUEsR0FBbkJBLFVBQXFCQSxJQUFtQkE7UUFFdENHLElBQUlBLFNBQVNBLEdBQUdBLEVBQUVBLENBQUNBO1FBRW5CQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNwQkEsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBQ0EsQ0FBQ0E7WUFDcEJBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO1FBQzdCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNIQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQTtJQUVuQkEsQ0FBQ0E7SUFFTUgsc0NBQWNBLEdBQXJCQSxVQUF1QkEsSUFBNERBO1FBRWpGSSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxNQUFNQSxFQUFHQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNyREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsRUFBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7Z0JBQ3hEQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN4Q0EsQ0FBQ0E7UUFDSEEsQ0FBQ0E7SUFFSEEsQ0FBQ0E7SUFFTUosK0JBQU9BLEdBQWRBLFVBQWdCQSxJQUFtQkE7UUFFakNLLElBQUlBLEdBQUdBLEdBQUdBLEVBQUVBLENBQUNBO1FBRWJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUdBLENBQUNBLEVBQUdBLEVBQUdBLENBQUNBO1lBRXpDQSxBQUNBQSxrQ0FEa0NBO1lBQ2xDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQTtZQUM3Q0EsQUFDQUEsMkNBRDJDQTtZQUMzQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsTUFBTUEsRUFBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7Z0JBQ3JEQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBLENBQUNBO1lBQzNEQSxDQUFDQTtZQUNEQSxBQUNBQSw4QkFEOEJBO1lBQzlCQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtZQUV4Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25EQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxzQkFBb0JBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQVFBLENBQUNBLENBQUNBO1lBQ3REQSxDQUFDQTtRQUVIQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQTtJQUViQSxDQUFDQTtJQUVNTCw0QkFBSUEsR0FBWEEsVUFBYUEsSUFBbUJBO1FBRTlCTSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUMxQkEsQ0FBQ0EsR0FBV0EsQ0FBQ0EsRUFDYkEsVUFBVUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFFbkJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3JDQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0REEsQ0FBQ0E7UUFFREEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFFcEJBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLFVBQUNBLENBQUNBO1lBQ3BCQSxVQUFVQSxJQUFJQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0Q0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFSEEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsY0FBY0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsVUFBVUEsQ0FBQ0E7UUFFakZBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO0lBRVhBLENBQUNBO0lBRU1OLGdDQUFRQSxHQUFmQSxVQUFpQkEsSUFBbUJBO1FBRWxDTyxJQUFJQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUViQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFHQSxDQUFDQSxFQUFHQSxFQUFHQSxDQUFDQTtZQUV6Q0EsSUFBSUEsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsRUFDZkEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFcENBLEFBQ0FBLHNDQURzQ0E7WUFDdENBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLFlBQVlBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBO1lBQzNDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxZQUFZQSxHQUFHQSxtQkFBR0EsQ0FBQ0EsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDeERBLEFBQ0FBLHdEQUR3REE7WUFDeERBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLEVBQUdBLENBQUNBLElBQUlBLENBQUNBLEVBQUdBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUMxREEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7WUFDekRBLENBQUNBO1lBQ0RBLEFBQ0FBLHFDQURxQ0E7WUFDckNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLE1BQU1BLEVBQUlBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUN0REEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtZQUMzQ0EsQ0FBQ0E7WUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FB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dGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi9hbGwuZC50c1wiIC8+XG5cbmltcG9ydCB7YWRkLCBzdWIsIG11bHRpcGx5QnlTY2FsYXIsIGFkZFNjYWxhciwgc3VtLCB6ZXJvcywgc2h1ZmZsZSwgcm9vdE1lYW5TcXVhcmV9IGZyb20gJ25lcnZvdXMtYXJyYXknO1xuaW1wb3J0IHtzaWdtb2lkLCBzaWdtb2lkUHJpbWV9IGZyb20gJ25lcnZvdXMtc2lnbW9pZCc7XG5cbmltcG9ydCB7TGF5ZXIsIElucHV0TGF5ZXIsIEhpZGRlbkxheWVyLCBPdXRwdXRMYXllcn0gZnJvbSAnLi9sYXllcic7XG5pbXBvcnQge1N5bmFwc2UsIElTeW5hcHNlc0xheWVyfSBmcm9tICcuL3N5bmFwc2UnO1xuaW1wb3J0IHtDb3N0U3RyYXRlZ3ksIEVDb3N0U3RyYXRlZ3ksIFF1YWRyYXRpY0Nvc3QsIENyb3NzRW50cm9weUNvc3R9IGZyb20gJy4vY29zdCc7XG5cbmltcG9ydCAnLi9wb2x5ZmlsbHMvYXNzaWduJztcblxuZXhwb3J0IGludGVyZmFjZSBJQWN0aXZhdGlvbkZ1bmN0aW9ucyB7XG4gIGFjdGl2YXRpb246ICh6OiBudW1iZXIpID0+IG51bWJlcjtcbiAgYWN0aXZhdGlvblByaW1lOiAoejogbnVtYmVyKSA9PiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVRyYWluaW5nQ29uZmlndXJhdGlvbiB7XG4gIHJlZ3VsYXJpemF0aW9uPzogbnVtYmVyO1xuICBiYXRjaFNpemU/OiBudW1iZXI7XG4gIGxlYXJuaW5nUmF0ZT86IG51bWJlcjtcbiAgaXRlcmF0aW9ucz86IG51bWJlcjtcbiAgbG9nPzogYm9vbGVhbjtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSU5ldXJhbE5ldHdvcmtDb25maWd1cmF0aW9uIHtcbiAgaW5wdXRMYXllclNpemU6IG51bWJlcjtcbiAgaGlkZGVuTGF5ZXJzPzogbnVtYmVyW107XG4gIG91dHB1dExheWVyU2l6ZTogbnVtYmVyO1xuICB0cmFpbmluZ09wdGlvbnM/OiBJVHJhaW5pbmdDb25maWd1cmF0aW9uO1xuICBjb3N0U3RyYXRlZ3k/OiBFQ29zdFN0cmF0ZWd5O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElUdXBsZSB7XG4gIGlucHV0OiBBcnJheTxudW1iZXI+O1xuICBvdXRwdXQ/OiBBcnJheTxudW1iZXI+OyBcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSVRyYWluaW5nRGF0YSBleHRlbmRzIEFycmF5PElUdXBsZT4ge31cblxuZXhwb3J0IGludGVyZmFjZSBJVHJhaW5pbmdPdXRwdXQge1xuICBlcnJvcjogbnVtYmVyXG59XG5cbmV4cG9ydCBjbGFzcyBOZXVyYWxOZXR3b3JrIHtcbiAgXG4gIHByaXZhdGUgbmV1cm9uc0xheWVyczogTGF5ZXJbXTtcbiAgcHJpdmF0ZSBzeW5hcHNlc0xheWVyczogSVN5bmFwc2VzTGF5ZXJbXTtcbiAgcHJpdmF0ZSBudW1iZXJPZlN5bmFwc2VzOiBudW1iZXI7XG4gIHByaXZhdGUgaW5wdXRMYXllcjogSW5wdXRMYXllcjtcbiAgcHJpdmF0ZSBvdXRwdXRMYXllcjogT3V0cHV0TGF5ZXI7XG4gIFxuICBwcml2YXRlIGFjdGl2YXRpb25GdW5jdGlvbnM6IElBY3RpdmF0aW9uRnVuY3Rpb25zO1xuICBwcml2YXRlIGNvc3RTdHJhdGVneTogQ29zdFN0cmF0ZWd5O1xuXG4gIGNvbnN0cnVjdG9yIChcbiAgICBwcml2YXRlIGNvbmZpZzogSU5ldXJhbE5ldHdvcmtDb25maWd1cmF0aW9uXG4gICkge1xuICAgIFxuICAgIHRoaXMuY29uZmlnLmhpZGRlbkxheWVycyA9IDxudW1iZXJbXT4oKHR5cGVvZiB0aGlzLmNvbmZpZy5oaWRkZW5MYXllcnMgPT09ICdudW1iZXInKSA/IFt0aGlzLmNvbmZpZy5oaWRkZW5MYXllcnNdIDogdGhpcy5jb25maWcuaGlkZGVuTGF5ZXJzKTtcbiAgICBcbiAgICB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMgPSB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMgfHwge307XG4gICAgdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLml0ZXJhdGlvbnMgPSB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMuaXRlcmF0aW9ucyB8fCAxMDAwMDtcbiAgICB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMuYmF0Y2hTaXplID0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmJhdGNoU2l6ZSB8fCAxMDtcbiAgICB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMucmVndWxhcml6YXRpb24gPSAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLnJlZ3VsYXJpemF0aW9uID09PSB1bmRlZmluZWQpID8gMC4wMDAxIDogdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLnJlZ3VsYXJpemF0aW9uO1xuICAgIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5sZWFybmluZ1JhdGUgPSAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSA9PT0gdW5kZWZpbmVkKSA/IDAuNSA6IHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5sZWFybmluZ1JhdGU7XG4gICAgXG4gICAgdGhpcy5hY3RpdmF0aW9uRnVuY3Rpb25zID0ge1xuICAgICAgYWN0aXZhdGlvbjogc2lnbW9pZCxcbiAgICAgIGFjdGl2YXRpb25QcmltZTogc2lnbW9pZFByaW1lXG4gICAgfTtcbiAgICBcbiAgICBzd2l0Y2ggKHRoaXMuY29uZmlnLmNvc3RTdHJhdGVneSkge1xuICAgICAgY2FzZSBFQ29zdFN0cmF0ZWd5LlF1YWRyYXRpYzpcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuY29zdFN0cmF0ZWd5ID0gbmV3IFF1YWRyYXRpY0Nvc3QodGhpcy5hY3RpdmF0aW9uRnVuY3Rpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEVDb3N0U3RyYXRlZ3kuQ3Jvc3NFbnRyb3B5OlxuICAgICAgICB0aGlzLmNvc3RTdHJhdGVneSA9IG5ldyBDcm9zc0VudHJvcHlDb3N0KHRoaXMuYWN0aXZhdGlvbkZ1bmN0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgIFxuICAgIHRoaXMubmV1cm9uc0xheWVycyA9IFtdO1xuICAgIHRoaXMuc3luYXBzZXNMYXllcnMgPSBbXTtcbiAgICB0aGlzLm51bWJlck9mU3luYXBzZXMgPSAwO1xuXG4gICAgLy9sYXllcnMgY3JlYXRpb25cbiAgICB0aGlzLm5ldXJvbnNMYXllcnMucHVzaCh0aGlzLmlucHV0TGF5ZXIgPSBuZXcgSW5wdXRMYXllcihjb25maWcuaW5wdXRMYXllclNpemUpKTtcbiAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBjb25maWcuaGlkZGVuTGF5ZXJzLmxlbmd0aCA7IGkrKykge1xuICAgICAgdGhpcy5uZXVyb25zTGF5ZXJzLnB1c2gobmV3IEhpZGRlbkxheWVyKGNvbmZpZy5oaWRkZW5MYXllcnNbaV0pKTtcbiAgICB9XG4gICAgdGhpcy5uZXVyb25zTGF5ZXJzLnB1c2godGhpcy5vdXRwdXRMYXllciA9IG5ldyBPdXRwdXRMYXllcihjb25maWcub3V0cHV0TGF5ZXJTaXplKSk7XG5cbiAgICAvL3N5bmFwc2VzIGNyZWF0aW9uXG4gICAgZm9yIChsZXQgaiA9IDAgOyBqIDwgdGhpcy5uZXVyb25zTGF5ZXJzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgbGV0IHN5bmFwc2VzID0gdGhpcy5uZXVyb25zTGF5ZXJzW2pdLmxpbmtUbyh0aGlzLm5ldXJvbnNMYXllcnNbaiArIDFdKTtcbiAgICAgIHRoaXMuc3luYXBzZXNMYXllcnMucHVzaChzeW5hcHNlcyk7XG4gICAgICB0aGlzLm51bWJlck9mU3luYXBzZXMgKz0gc3luYXBzZXMubGVuZ3RoO1xuICAgIH1cblxuICB9XG5cbiAgZ2V0IHdlaWdodHMgKCk6IG51bWJlcltdIHtcbiAgICBcbiAgICBsZXQgd2VpZ2h0cyA9IFtdO1xuICAgIFxuICAgIHRoaXMuZm9yRWFjaFN5bmFwc2UoKHMpID0+IHtcbiAgICAgIHdlaWdodHMucHVzaChzLndlaWdodCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHdlaWdodHM7XG4gICAgXG4gIH1cbiAgc2V0IHdlaWdodHMgKHN5bmFwc2VzOiBudW1iZXJbXSkge1xuICAgIFxuICAgIGlmIChzeW5hcHNlcy5sZW5ndGggIT09IHRoaXMubnVtYmVyT2ZTeW5hcHNlcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbnVtYmVyIG9mIHN5bmFwc2VzIGRpZmZlcnMuYCk7XG4gICAgfVxuICAgIFxuICAgIGxldCBjcHQgPSAwO1xuICAgIFxuICAgIHRoaXMuZm9yRWFjaFN5bmFwc2UoKHMpID0+IHtcbiAgICAgIHMud2VpZ2h0ID0gc3luYXBzZXNbY3B0KytdO1xuICAgIH0pO1xuICAgIFxuICB9XG4gIFxuICBwdWJsaWMgZ2V0R3JhZGllbnRzIChkYXRhOiBJVHJhaW5pbmdEYXRhKTogbnVtYmVyW10ge1xuICAgIFxuICAgIGxldCBncmFkaWVudHMgPSBbXTsgXG4gICAgXG4gICAgdGhpcy5iYWNrd2FyZChkYXRhKTtcbiAgICB0aGlzLmZvckVhY2hTeW5hcHNlKChzKSA9PiB7XG4gICAgICBncmFkaWVudHMucHVzaChzLmdyYWRpZW50KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZ3JhZGllbnRzO1xuICAgIFxuICB9XG4gIFxuICBwdWJsaWMgZm9yRWFjaFN5bmFwc2UgKGZ1bmM6ICh4OiBTeW5hcHNlLCBpbmRleEk/OiBudW1iZXIsIGluZGV4Sj86IG51bWJlcikgPT4gdm9pZCkge1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zeW5hcHNlc0xheWVycy5sZW5ndGggOyBpKyspIHtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGhpcy5zeW5hcHNlc0xheWVyc1tpXS5sZW5ndGggOyBqKyspIHtcbiAgICAgICAgZnVuYyh0aGlzLnN5bmFwc2VzTGF5ZXJzW2ldW2pdLCBpLCBqKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gIH1cblxuICBwdWJsaWMgZm9yd2FyZCAoZGF0YTogSVRyYWluaW5nRGF0YSk6IG51bWJlcltdW10ge1xuXG4gICAgbGV0IHJldCA9IFtdO1xuXG4gICAgZm9yIChsZXQgayA9IDAgOyBrIDwgZGF0YS5sZW5ndGggOyBrICsrICkge1xuICAgICAgXG4gICAgICAvL3NldCBpbnB1dCB0byBpbnB1dCBsYXllciBuZXVyb25zXG4gICAgICB0aGlzLmlucHV0TGF5ZXIubmV1cm9uc1ZhbHVlID0gZGF0YVtrXS5pbnB1dDtcbiAgICAgIC8vcHJvcGFnYXRlIG9uIGVhY2ggaGlkZGVuIGxheWVyIGFuZCBvdXRwdXRcbiAgICAgIGZvciAobGV0IGkgPSAxIDsgaSA8IHRoaXMubmV1cm9uc0xheWVycy5sZW5ndGggOyBpKyspIHtcbiAgICAgICAgdGhpcy5uZXVyb25zTGF5ZXJzW2ldLmFjdGl2YXRlKHRoaXMuYWN0aXZhdGlvbkZ1bmN0aW9ucyk7XG4gICAgICB9XG4gICAgICAvL3JldHJpZXZlIG91dHB1dCBuZXVyb24gdmFsdWVcbiAgICAgIHJldC5wdXNoKHRoaXMub3V0cHV0TGF5ZXIubmV1cm9uc1ZhbHVlKTtcbiAgICAgIFxuICAgICAgaWYgKHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5sb2cgJiYgayAlIDIgPT09IDApIHtcbiAgICAgICAgY29uc29sZS5pbmZvKGBGb3J3YXJkIFByb2dyZXNzICR7ayAvIGRhdGEubGVuZ3RofWApO1xuICAgICAgfVxuICAgICAgXG4gICAgfVxuICAgIHJldHVybiByZXQ7XG4gICAgXG4gIH1cblxuICBwdWJsaWMgY29zdCAoZGF0YTogSVRyYWluaW5nRGF0YSk6IG51bWJlciB7XG5cbiAgICBsZXQgeUhhdHMgPSB0aGlzLmZvcndhcmQoZGF0YSksXG4gICAgICAgIGo6IG51bWJlciA9IDAsXG4gICAgICAgIHdlaWdodHNTdW0gPSAwO1xuICAgIFxuICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZGF0YS5sZW5ndGg7IGsrKykge1xuICAgICAgaiArPSB0aGlzLmNvc3RTdHJhdGVneS5mbihkYXRhW2tdLm91dHB1dCwgeUhhdHNba10pO1xuICAgIH1cbiAgICBcbiAgICBqID0gaiAvIGRhdGEubGVuZ3RoO1xuICAgIFxuICAgIHRoaXMuZm9yRWFjaFN5bmFwc2UoKHMpID0+IHtcbiAgICAgIHdlaWdodHNTdW0gKz0gTWF0aC5wb3cocy53ZWlnaHQsIDIpO1xuICAgIH0pO1xuICAgIFxuICAgIGogKz0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLnJlZ3VsYXJpemF0aW9uIC8gKDIgKiBkYXRhLmxlbmd0aCkgKiB3ZWlnaHRzU3VtO1xuICAgIFxuICAgIHJldHVybiBqO1xuIFxuICB9XG5cbiAgcHVibGljIGJhY2t3YXJkIChkYXRhOiBJVHJhaW5pbmdEYXRhKTogSVN5bmFwc2VzTGF5ZXJbXSB7XG5cbiAgICBsZXQgcmV0ID0gW107XG5cbiAgICBmb3IgKGxldCBrID0gMCA7IGsgPCBkYXRhLmxlbmd0aCA7IGsgKysgKSB7XG4gICAgICBcbiAgICAgIGxldCB0dXBsZSA9IGRhdGFba10sXG4gICAgICAgICAgeUhhdCA9IHRoaXMuZm9yd2FyZChbdHVwbGVdKVswXTtcblxuICAgICAgLy9zZXQgdGhlIGlucHV0IGFuZCBvdXRwdXQgbGF5ZXIgdmFsdWVcbiAgICAgIHRoaXMuaW5wdXRMYXllci5uZXVyb25zVmFsdWUgPSB0dXBsZS5pbnB1dDtcbiAgICAgIHRoaXMub3V0cHV0TGF5ZXIubmV1cm9uc1ZhbHVlID0gc3ViKHlIYXQsIHR1cGxlLm91dHB1dCk7XG4gICAgICAvL2NvbXB1dGUgcHJvcGFnYXRpb24gZXJyb3JzIGZvciBhbGwgbGF5ZXJzIGV4cGVjdCBpbnB1dFxuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubmV1cm9uc0xheWVycy5sZW5ndGggLSAxIDsgaSA+PSAxIDsgaS0tKSB7XG4gICAgICAgIHRoaXMubmV1cm9uc0xheWVyc1tpXS5jb21wdXRlRXJyb3JzKHRoaXMuY29zdFN0cmF0ZWd5KTtcbiAgICAgIH1cbiAgICAgIC8vY29tcHV0ZSBkSmRXIGZvciBhbGwgc3luYXBzZXMgbGF5ZXJcbiAgICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHRoaXMubmV1cm9uc0xheWVycy5sZW5ndGggIDsgaSsrKSB7XG4gICAgICAgIHRoaXMubmV1cm9uc0xheWVyc1tpXS5jb21wdXRlR3JhZGllbnRzKCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmICh0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMubG9nICYmIGsgJSAyID09PSAwKSB7XG4gICAgICAgIGNvbnNvbGUuaW5mbyhgQmFja3dhcmQgUHJvZ3Jlc3MgJHtrIC8gZGF0YS5sZW5ndGh9YCk7XG4gICAgICB9XG5cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHRoaXMuc3luYXBzZXNMYXllcnM7XG5cbiAgfVxuXG4gIHB1YmxpYyBhZGp1c3RXZWlnaHRzIChzeW5hcHNlczogSVN5bmFwc2VzTGF5ZXJbXSwgYmF0Y2hTaXplOiBudW1iZXIsIGRhdGFTaXplOiBudW1iZXIpIHtcblxuICAgIGlmIChzeW5hcHNlcy5sZW5ndGggIT09IHRoaXMuc3luYXBzZXNMYXllcnMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBudW1iZXIgb2Ygc3luYXBzZXMgbGF5ZXJzIGRpZmZlcnMuYCk7XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3luYXBzZXMubGVuZ3RoIDsgaSsrKSB7XG4gICAgICBpZiAoc3luYXBzZXNbaV0ubGVuZ3RoICE9PSB0aGlzLnN5bmFwc2VzTGF5ZXJzW2ldLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBudW1iZXIgb2Ygc3luYXBzZXMgaW4gdGhlICR7aX0gbGF5ZXIgZGlmZmVyc2ApO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICB0aGlzLmZvckVhY2hTeW5hcHNlKChzKSA9PiB7XG4gICAgICBzLndlaWdodCA9ICgxIC0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSAqIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5yZWd1bGFyaXphdGlvbiAvIGRhdGFTaXplKSAqIHMud2VpZ2h0IC0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSAvIGJhdGNoU2l6ZSAqIHMuZ3JhZGllbnQ7XG4gICAgICBzLmdyYWRpZW50ID0gMDtcbiAgICB9KTtcbiAgICBcbiAgfVxuICBcbiAgcHVibGljIHRyYWluIChkYXRhOiBJVHJhaW5pbmdEYXRhLCBvcHRpb25zPzogSVRyYWluaW5nQ29uZmlndXJhdGlvbik6IElUcmFpbmluZ091dHB1dCB7XG4gICAgXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMsIG9wdGlvbnMpO1xuICAgIFxuICAgIGxldCBpdGVyYXRpb25zID0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLml0ZXJhdGlvbnMsXG4gICAgICAgIGJhdGNoU2l6ZSA9IHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5iYXRjaFNpemUgPSAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmJhdGNoU2l6ZSA+IGRhdGEubGVuZ3RoKSA/IGRhdGEubGVuZ3RoIDogdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmJhdGNoU2l6ZTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBpdGVyYXRpb25zIDsgaSsrKSB7XG4gICAgICBcbiAgICAgIGlmIChiYXRjaFNpemUgJiYgYmF0Y2hTaXplICE9PSBkYXRhLmxlbmd0aCkge1xuICAgICAgICBzaHVmZmxlKGRhdGEpO1xuICAgICAgfVxuICAgICAgXG4gICAgICBsZXQgYmF0Y2ggPSBkYXRhLnNsaWNlKDAsIGJhdGNoU2l6ZSksIFxuICAgICAgICAgIHN5bmFwc2VzID0gdGhpcy5iYWNrd2FyZChiYXRjaCk7XG4gICAgICAgICAgXG4gICAgICB0aGlzLmFkanVzdFdlaWdodHMoc3luYXBzZXMsIGJhdGNoU2l6ZSwgZGF0YS5sZW5ndGgpO1xuICAgICAgXG4gICAgICBpZiAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxvZyAmJiBpICUgMiA9PT0gMCkge1xuICAgICAgICBjb25zb2xlLmluZm8oYFByb2dyZXNzICR7aSAvIGl0ZXJhdGlvbnN9LCBjb3N0OiAke3RoaXMuY29zdChkYXRhKX1gKTtcbiAgICAgIH1cbiAgICBcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGVycm9yOiB0aGlzLmNvc3QoZGF0YSlcbiAgICB9O1xuICAgIFxuICB9XG4gIFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZU51bWVyaWNhbEdyYWRpZW50cyAobjogTmV1cmFsTmV0d29yaywgZGF0YTogSVRyYWluaW5nRGF0YSkge1xuXG4gIGxldCBlcHNpbG9uID0gMWUtNCxcbiAgICAgIGluaXRpYWxXZWlnaHRzOiBudW1iZXJbXSA9IG4ud2VpZ2h0cyxcbiAgICAgIG51bUdyYWRzID0gaW5pdGlhbFdlaWdodHMubGVuZ3RoLFxuICAgICAgZ3JhZGllbnRzOiBudW1iZXJbXSA9IHplcm9zKG51bUdyYWRzKSxcbiAgICAgIHBlcnR1cmI6IEFycmF5PG51bWJlcj4gPSB6ZXJvcyhudW1HcmFkcyksXG4gICAgICBrO1xuICAgIFxuICBmb3IgKGsgPSAwOyBrIDwgbnVtR3JhZHM7IGsrKykge1xuXG4gICAgbGV0IGxvc3MxLCBsb3NzMjtcblxuICAgIHBlcnR1cmJba10gPSBlcHNpbG9uO1xuICAgIG4ud2VpZ2h0cyA9IGFkZChpbml0aWFsV2VpZ2h0cywgcGVydHVyYik7XG4gICAgbG9zczIgPSBuLmNvc3QoZGF0YSk7XG4gICAgbi53ZWlnaHRzID0gc3ViKGluaXRpYWxXZWlnaHRzLCBwZXJ0dXJiKTtcbiAgICBsb3NzMSA9IG4uY29zdChkYXRhKVxuICAgIGdyYWRpZW50c1trXSA9IGRhdGEubGVuZ3RoICogc3VtKG11bHRpcGx5QnlTY2FsYXIoc3ViKFtsb3NzMl0sIFtsb3NzMV0pLCAxIC8gKGVwc2lsb24gKiAyKSkpO1xuICAgIHBlcnR1cmJba10gPSAwO1xuXG4gIH1cbiAgbi53ZWlnaHRzID0gaW5pdGlhbFdlaWdodHM7XG4gIHJldHVybiBncmFkaWVudHM7XG5cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==