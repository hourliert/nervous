/// <reference path="./all.d.ts" />
var nervous_array_1 = require('nervous-array');
var nervous_sigmoid_1 = require('nervous-sigmoid');
var layer_1 = require('./layer');
var cost_1 = require('./cost');
require('./polyfills/assign');
var NeuralNetwork = (function () {
    function NeuralNetwork(config) {
        this.config = config;
        this.config.hiddenLayers = ((typeof this.config.hiddenLayers === 'number') ? [this.config.hiddenLayers] : this.config.hiddenLayers);
        this.config.trainingOptions = this.config.trainingOptions || {};
        this.config.trainingOptions.iterations = this.config.trainingOptions.iterations || 10000;
        this.config.trainingOptions.batchSize = this.config.trainingOptions.batchSize || 10;
        this.config.trainingOptions.regularization = (this.config.trainingOptions.regularization === undefined) ? 0.0001 : this.config.trainingOptions.regularization;
        this.config.trainingOptions.learningRate = (this.config.trainingOptions.learningRate === undefined) ? 0.5 : this.config.trainingOptions.learningRate;
        this.activationFunctions = {
            activation: nervous_sigmoid_1.sigmoid,
            activationPrime: nervous_sigmoid_1.sigmoidPrime
        };
        switch (this.config.costStrategy) {
            case cost_1.ECostStrategy.Quadratic:
            default:
                this.costStrategy = new cost_1.QuadraticCost(this.activationFunctions);
                break;
            case cost_1.ECostStrategy.CrossEntropy:
                this.costStrategy = new cost_1.CrossEntropyCost(this.activationFunctions);
                break;
        }
        this.neuronsLayers = [];
        this.synapsesLayers = [];
        this.numberOfSynapses = 0;
        //layers creation
        this.neuronsLayers.push(this.inputLayer = new layer_1.InputLayer(config.inputLayerSize));
        for (var i = 0; i < config.hiddenLayers.length; i++) {
            this.neuronsLayers.push(new layer_1.HiddenLayer(config.hiddenLayers[i]));
        }
        this.neuronsLayers.push(this.outputLayer = new layer_1.OutputLayer(config.outputLayerSize));
        //synapses creation
        for (var j = 0; j < this.neuronsLayers.length - 1; j++) {
            var synapses = this.neuronsLayers[j].linkTo(this.neuronsLayers[j + 1]);
            this.synapsesLayers.push(synapses);
            this.numberOfSynapses += synapses.length;
        }
    }
    Object.defineProperty(NeuralNetwork.prototype, "weights", {
        get: function () {
            var weights = [];
            this.forEachSynapse(function (s) {
                weights.push(s.weight);
            });
            return weights;
        },
        set: function (synapses) {
            if (synapses.length !== this.numberOfSynapses) {
                throw new Error("The number of synapses differs.");
            }
            var cpt = 0;
            this.forEachSynapse(function (s) {
                s.weight = synapses[cpt++];
            });
        },
        enumerable: true,
        configurable: true
    });
    NeuralNetwork.prototype.getGradients = function (data) {
        var gradients = [];
        this.backward(data);
        this.forEachSynapse(function (s) {
            gradients.push(s.gradient);
        });
        return gradients;
    };
    NeuralNetwork.prototype.forEachSynapse = function (func) {
        for (var i = 0; i < this.synapsesLayers.length; i++) {
            for (var j = 0; j < this.synapsesLayers[i].length; j++) {
                func(this.synapsesLayers[i][j], i, j);
            }
        }
    };
    NeuralNetwork.prototype.forward = function (data) {
        var ret = [];
        for (var k = 0; k < data.length; k++) {
            //set input to input layer neurons
            this.inputLayer.neuronsValue = data[k].input;
            //propagate on each hidden layer and output
            for (var i = 1; i < this.neuronsLayers.length; i++) {
                this.neuronsLayers[i].activate(this.activationFunctions);
            }
            //retrieve output neuron value
            ret.push(this.outputLayer.neuronsValue);
        }
        return ret;
    };
    NeuralNetwork.prototype.cost = function (data) {
        var yHats = this.forward(data), j = 0, weightsSum = 0;
        for (var k = 0; k < data.length; k++) {
            j += this.costStrategy.fn(data[k].output, yHats[k]);
        }
        j = j / data.length;
        this.forEachSynapse(function (s) {
            weightsSum += Math.pow(s.weight, 2);
        });
        j += this.config.trainingOptions.regularization / (2 * data.length) * weightsSum;
        return j;
    };
    NeuralNetwork.prototype.backward = function (data) {
        var ret = [];
        for (var k = 0; k < data.length; k++) {
            var tuple = data[k], yHat = this.forward([tuple])[0];
            //set the input and output layer value
            this.inputLayer.neuronsValue = tuple.input;
            this.outputLayer.neuronsValue = nervous_array_1.sub(yHat, tuple.output);
            //compute propagation errors for all layers expect input
            for (var i = this.neuronsLayers.length - 1; i >= 1; i--) {
                this.neuronsLayers[i].computeErrors(this.costStrategy);
            }
            //compute dJdW for all synapses layer
            for (var i = 0; i < this.neuronsLayers.length; i++) {
                this.neuronsLayers[i].computeGradients();
            }
        }
        return this.synapsesLayers;
    };
    NeuralNetwork.prototype.adjustWeights = function (synapses, batchSize, dataSize) {
        var _this = this;
        if (synapses.length !== this.synapsesLayers.length) {
            throw new Error("The number of synapses layers differs.");
        }
        for (var i = 0; i < synapses.length; i++) {
            if (synapses[i].length !== this.synapsesLayers[i].length) {
                throw new Error("The number of synapses in the " + i + " layer differs");
            }
        }
        this.forEachSynapse(function (s) {
            s.weight = (1 - _this.config.trainingOptions.learningRate * _this.config.trainingOptions.regularization / dataSize) * s.weight - _this.config.trainingOptions.learningRate / batchSize * s.gradient;
            s.gradient = 0;
        });
    };
    NeuralNetwork.prototype.train = function (data, options) {
        Object.assign(this.config.trainingOptions, options);
        var iterations = this.config.trainingOptions.iterations, batchSize = this.config.trainingOptions.batchSize = (this.config.trainingOptions.batchSize > data.length) ? data.length : this.config.trainingOptions.batchSize;
        for (var i = 0; i < iterations; i++) {
            if (batchSize && batchSize !== data.length) {
                nervous_array_1.shuffle(data);
            }
            var batch = data.slice(0, batchSize), synapses = this.backward(batch);
            this.adjustWeights(synapses, batchSize, data.length);
            if (this.config.trainingOptions.log && i % 2 === 0) {
                console.info("Progress " + i / iterations + ", cost: " + this.cost(data));
            }
        }
        return {
            error: this.cost(data)
        };
    };
    return NeuralNetwork;
})();
exports.NeuralNetwork = NeuralNetwork;
function computeNumericalGradients(n, data) {
    var epsilon = 1e-4, initialWeights = n.weights, numGrads = initialWeights.length, gradients = nervous_array_1.zeros(numGrads), perturb = nervous_array_1.zeros(numGrads), k;
    for (k = 0; k < numGrads; k++) {
        var loss1 = void 0, loss2 = void 0;
        perturb[k] = epsilon;
        n.weights = nervous_array_1.add(initialWeights, perturb);
        loss2 = n.cost(data);
        n.weights = nervous_array_1.sub(initialWeights, perturb);
        loss1 = n.cost(data);
        gradients[k] = data.length * nervous_array_1.sum(nervous_array_1.multiplyByScalar(nervous_array_1.sub([loss2], [loss1]), 1 / (epsilon * 2)));
        perturb[k] = 0;
    }
    n.weights = initialWeights;
    return gradients;
}
exports.computeNumericalGradients = computeNumericalGradients;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5ldXJhbC1uZXR3b3JrLnRzIl0sIm5hbWVzIjpbIk5ldXJhbE5ldHdvcmsiLCJOZXVyYWxOZXR3b3JrLmNvbnN0cnVjdG9yIiwiTmV1cmFsTmV0d29yay53ZWlnaHRzIiwiTmV1cmFsTmV0d29yay5nZXRHcmFkaWVudHMiLCJOZXVyYWxOZXR3b3JrLmZvckVhY2hTeW5hcHNlIiwiTmV1cmFsTmV0d29yay5mb3J3YXJkIiwiTmV1cmFsTmV0d29yay5jb3N0IiwiTmV1cmFsTmV0d29yay5iYWNrd2FyZCIsIk5ldXJhbE5ldHdvcmsuYWRqdXN0V2VpZ2h0cyIsIk5ldXJhbE5ldHdvcmsudHJhaW4iLCJjb21wdXRlTnVtZXJpY2FsR3JhZGllbnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxtQ0FBbUM7QUFFbkMsOEJBQXlGLGVBQWUsQ0FBQyxDQUFBO0FBQ3pHLGdDQUFvQyxpQkFBaUIsQ0FBQyxDQUFBO0FBRXRELHNCQUEwRCxTQUFTLENBQUMsQ0FBQTtBQUVwRSxxQkFBMkUsUUFBUSxDQUFDLENBQUE7QUFFcEYsUUFBTyxvQkFBb0IsQ0FBQyxDQUFBO0FBZ0M1QjtJQVdFQSx1QkFDVUEsTUFBbUNBO1FBQW5DQyxXQUFNQSxHQUFOQSxNQUFNQSxDQUE2QkE7UUFHM0NBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLEdBQWFBLENBQUNBLENBQUNBLE9BQU9BLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLEtBQUtBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRTlJQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxlQUFlQSxJQUFJQSxFQUFFQSxDQUFDQTtRQUNoRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsVUFB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Q0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQUE7UUFDcEJBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLG1CQUFHQSxDQUFDQSxnQ0FBZ0JBLENBQUNBLG1CQUFHQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM3RkEsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFFakJBLENBQUNBO0lBQ0RBLENBQUNBLENBQUNBLE9BQU9BLEdBQUdBLGNBQWNBLENBQUNBO0lBQzNCQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQTtBQUVuQkEsQ0FBQ0E7QUF6QmUsaUNBQXlCLDRCQXlCeEMsQ0FBQSIsImZpbGUiOiJuZXVyYWwtbmV0d29yay5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuL2FsbC5kLnRzXCIgLz5cblxuaW1wb3J0IHthZGQsIHN1YiwgbXVsdGlwbHlCeVNjYWxhciwgYWRkU2NhbGFyLCBzdW0sIHplcm9zLCBzaHVmZmxlLCByb290TWVhblNxdWFyZX0gZnJvbSAnbmVydm91cy1hcnJheSc7XG5pbXBvcnQge3NpZ21vaWQsIHNpZ21vaWRQcmltZX0gZnJvbSAnbmVydm91cy1zaWdtb2lkJztcblxuaW1wb3J0IHtMYXllciwgSW5wdXRMYXllciwgSGlkZGVuTGF5ZXIsIE91dHB1dExheWVyfSBmcm9tICcuL2xheWVyJztcbmltcG9ydCB7U3luYXBzZSwgSVN5bmFwc2VzTGF5ZXJ9IGZyb20gJy4vc3luYXBzZSc7XG5pbXBvcnQge0Nvc3RTdHJhdGVneSwgRUNvc3RTdHJhdGVneSwgUXVhZHJhdGljQ29zdCwgQ3Jvc3NFbnRyb3B5Q29zdH0gZnJvbSAnLi9jb3N0JztcblxuaW1wb3J0ICcuL3BvbHlmaWxscy9hc3NpZ24nO1xuXG5leHBvcnQgaW50ZXJmYWNlIElBY3RpdmF0aW9uRnVuY3Rpb25zIHtcbiAgYWN0aXZhdGlvbjogKHo6IG51bWJlcikgPT4gbnVtYmVyO1xuICBhY3RpdmF0aW9uUHJpbWU6ICh6OiBudW1iZXIpID0+IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJVHJhaW5pbmdDb25maWd1cmF0aW9uIHtcbiAgcmVndWxhcml6YXRpb24/OiBudW1iZXI7XG4gIGJhdGNoU2l6ZT86IG51bWJlcjtcbiAgbGVhcm5pbmdSYXRlPzogbnVtYmVyO1xuICBpdGVyYXRpb25zPzogbnVtYmVyO1xuICBsb2c/OiBib29sZWFuO1xufVxuZXhwb3J0IGludGVyZmFjZSBJTmV1cmFsTmV0d29ya0NvbmZpZ3VyYXRpb24ge1xuICBpbnB1dExheWVyU2l6ZTogbnVtYmVyO1xuICBoaWRkZW5MYXllcnM/OiBudW1iZXJbXTtcbiAgb3V0cHV0TGF5ZXJTaXplOiBudW1iZXI7XG4gIHRyYWluaW5nT3B0aW9ucz86IElUcmFpbmluZ0NvbmZpZ3VyYXRpb247XG4gIGNvc3RTdHJhdGVneT86IEVDb3N0U3RyYXRlZ3k7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVR1cGxlIHtcbiAgaW5wdXQ6IEFycmF5PG51bWJlcj47XG4gIG91dHB1dD86IEFycmF5PG51bWJlcj47IFxufVxuZXhwb3J0IGludGVyZmFjZSBJVHJhaW5pbmdEYXRhIGV4dGVuZHMgQXJyYXk8SVR1cGxlPiB7fVxuXG5leHBvcnQgaW50ZXJmYWNlIElUcmFpbmluZ091dHB1dCB7XG4gIGVycm9yOiBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIE5ldXJhbE5ldHdvcmsge1xuICBcbiAgcHJpdmF0ZSBuZXVyb25zTGF5ZXJzOiBMYXllcltdO1xuICBwcml2YXRlIHN5bmFwc2VzTGF5ZXJzOiBJU3luYXBzZXNMYXllcltdO1xuICBwcml2YXRlIG51bWJlck9mU3luYXBzZXM6IG51bWJlcjtcbiAgcHJpdmF0ZSBpbnB1dExheWVyOiBJbnB1dExheWVyO1xuICBwcml2YXRlIG91dHB1dExheWVyOiBPdXRwdXRMYXllcjtcbiAgXG4gIHByaXZhdGUgYWN0aXZhdGlvbkZ1bmN0aW9uczogSUFjdGl2YXRpb25GdW5jdGlvbnM7XG4gIHByaXZhdGUgY29zdFN0cmF0ZWd5OiBDb3N0U3RyYXRlZ3k7XG5cbiAgY29uc3RydWN0b3IgKFxuICAgIHByaXZhdGUgY29uZmlnOiBJTmV1cmFsTmV0d29ya0NvbmZpZ3VyYXRpb25cbiAgKSB7XG4gICAgXG4gICAgdGhpcy5jb25maWcuaGlkZGVuTGF5ZXJzID0gPG51bWJlcltdPigodHlwZW9mIHRoaXMuY29uZmlnLmhpZGRlbkxheWVycyA9PT0gJ251bWJlcicpID8gW3RoaXMuY29uZmlnLmhpZGRlbkxheWVyc10gOiB0aGlzLmNvbmZpZy5oaWRkZW5MYXllcnMpO1xuICAgIFxuICAgIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucyA9IHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMuaXRlcmF0aW9ucyA9IHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5pdGVyYXRpb25zIHx8IDEwMDAwO1xuICAgIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5iYXRjaFNpemUgPSB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMuYmF0Y2hTaXplIHx8IDEwO1xuICAgIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5yZWd1bGFyaXphdGlvbiA9ICh0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMucmVndWxhcml6YXRpb24gPT09IHVuZGVmaW5lZCkgPyAwLjAwMDEgOiB0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMucmVndWxhcml6YXRpb247XG4gICAgdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSA9ICh0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMubGVhcm5pbmdSYXRlID09PSB1bmRlZmluZWQpID8gMC41IDogdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZTtcbiAgICBcbiAgICB0aGlzLmFjdGl2YXRpb25GdW5jdGlvbnMgPSB7XG4gICAgICBhY3RpdmF0aW9uOiBzaWdtb2lkLFxuICAgICAgYWN0aXZhdGlvblByaW1lOiBzaWdtb2lkUHJpbWVcbiAgICB9O1xuICAgIFxuICAgIHN3aXRjaCAodGhpcy5jb25maWcuY29zdFN0cmF0ZWd5KSB7XG4gICAgICBjYXNlIEVDb3N0U3RyYXRlZ3kuUXVhZHJhdGljOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5jb3N0U3RyYXRlZ3kgPSBuZXcgUXVhZHJhdGljQ29zdCh0aGlzLmFjdGl2YXRpb25GdW5jdGlvbnMpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRUNvc3RTdHJhdGVneS5Dcm9zc0VudHJvcHk6XG4gICAgICAgIHRoaXMuY29zdFN0cmF0ZWd5ID0gbmV3IENyb3NzRW50cm9weUNvc3QodGhpcy5hY3RpdmF0aW9uRnVuY3Rpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgXG4gICAgdGhpcy5uZXVyb25zTGF5ZXJzID0gW107XG4gICAgdGhpcy5zeW5hcHNlc0xheWVycyA9IFtdO1xuICAgIHRoaXMubnVtYmVyT2ZTeW5hcHNlcyA9IDA7XG5cbiAgICAvL2xheWVycyBjcmVhdGlvblxuICAgIHRoaXMubmV1cm9uc0xheWVycy5wdXNoKHRoaXMuaW5wdXRMYXllciA9IG5ldyBJbnB1dExheWVyKGNvbmZpZy5pbnB1dExheWVyU2l6ZSkpO1xuICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IGNvbmZpZy5oaWRkZW5MYXllcnMubGVuZ3RoIDsgaSsrKSB7XG4gICAgICB0aGlzLm5ldXJvbnNMYXllcnMucHVzaChuZXcgSGlkZGVuTGF5ZXIoY29uZmlnLmhpZGRlbkxheWVyc1tpXSkpO1xuICAgIH1cbiAgICB0aGlzLm5ldXJvbnNMYXllcnMucHVzaCh0aGlzLm91dHB1dExheWVyID0gbmV3IE91dHB1dExheWVyKGNvbmZpZy5vdXRwdXRMYXllclNpemUpKTtcblxuICAgIC8vc3luYXBzZXMgY3JlYXRpb25cbiAgICBmb3IgKGxldCBqID0gMCA7IGogPCB0aGlzLm5ldXJvbnNMYXllcnMubGVuZ3RoIC0gMTsgaisrKSB7XG4gICAgICBsZXQgc3luYXBzZXMgPSB0aGlzLm5ldXJvbnNMYXllcnNbal0ubGlua1RvKHRoaXMubmV1cm9uc0xheWVyc1tqICsgMV0pO1xuICAgICAgdGhpcy5zeW5hcHNlc0xheWVycy5wdXNoKHN5bmFwc2VzKTtcbiAgICAgIHRoaXMubnVtYmVyT2ZTeW5hcHNlcyArPSBzeW5hcHNlcy5sZW5ndGg7XG4gICAgfVxuXG4gIH1cblxuICBnZXQgd2VpZ2h0cyAoKTogbnVtYmVyW10ge1xuICAgIFxuICAgIGxldCB3ZWlnaHRzID0gW107XG4gICAgXG4gICAgdGhpcy5mb3JFYWNoU3luYXBzZSgocykgPT4ge1xuICAgICAgd2VpZ2h0cy5wdXNoKHMud2VpZ2h0KTtcbiAgICB9KTtcbiAgICByZXR1cm4gd2VpZ2h0cztcbiAgICBcbiAgfVxuICBzZXQgd2VpZ2h0cyAoc3luYXBzZXM6IG51bWJlcltdKSB7XG4gICAgXG4gICAgaWYgKHN5bmFwc2VzLmxlbmd0aCAhPT0gdGhpcy5udW1iZXJPZlN5bmFwc2VzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBudW1iZXIgb2Ygc3luYXBzZXMgZGlmZmVycy5gKTtcbiAgICB9XG4gICAgXG4gICAgbGV0IGNwdCA9IDA7XG4gICAgXG4gICAgdGhpcy5mb3JFYWNoU3luYXBzZSgocykgPT4ge1xuICAgICAgcy53ZWlnaHQgPSBzeW5hcHNlc1tjcHQrK107XG4gICAgfSk7XG4gICAgXG4gIH1cbiAgXG4gIHB1YmxpYyBnZXRHcmFkaWVudHMgKGRhdGE6IElUcmFpbmluZ0RhdGEpOiBudW1iZXJbXSB7XG4gICAgXG4gICAgbGV0IGdyYWRpZW50cyA9IFtdOyBcbiAgICBcbiAgICB0aGlzLmJhY2t3YXJkKGRhdGEpO1xuICAgIHRoaXMuZm9yRWFjaFN5bmFwc2UoKHMpID0+IHtcbiAgICAgIGdyYWRpZW50cy5wdXNoKHMuZ3JhZGllbnQpO1xuICAgIH0pO1xuICAgIHJldHVybiBncmFkaWVudHM7XG4gICAgXG4gIH1cbiAgXG4gIHB1YmxpYyBmb3JFYWNoU3luYXBzZSAoZnVuYzogKHg6IFN5bmFwc2UsIGluZGV4ST86IG51bWJlciwgaW5kZXhKPzogbnVtYmVyKSA9PiB2b2lkKSB7XG4gICAgXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN5bmFwc2VzTGF5ZXJzLmxlbmd0aCA7IGkrKykge1xuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLnN5bmFwc2VzTGF5ZXJzW2ldLmxlbmd0aCA7IGorKykge1xuICAgICAgICBmdW5jKHRoaXMuc3luYXBzZXNMYXllcnNbaV1bal0sIGksIGopO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgfVxuXG4gIHB1YmxpYyBmb3J3YXJkIChkYXRhOiBJVHJhaW5pbmdEYXRhKTogbnVtYmVyW11bXSB7XG5cbiAgICBsZXQgcmV0ID0gW107XG5cbiAgICBmb3IgKGxldCBrID0gMCA7IGsgPCBkYXRhLmxlbmd0aCA7IGsgKysgKSB7XG4gICAgICBcbiAgICAgIC8vc2V0IGlucHV0IHRvIGlucHV0IGxheWVyIG5ldXJvbnNcbiAgICAgIHRoaXMuaW5wdXRMYXllci5uZXVyb25zVmFsdWUgPSBkYXRhW2tdLmlucHV0O1xuICAgICAgLy9wcm9wYWdhdGUgb24gZWFjaCBoaWRkZW4gbGF5ZXIgYW5kIG91dHB1dFxuICAgICAgZm9yIChsZXQgaSA9IDEgOyBpIDwgdGhpcy5uZXVyb25zTGF5ZXJzLmxlbmd0aCA7IGkrKykge1xuICAgICAgICB0aGlzLm5ldXJvbnNMYXllcnNbaV0uYWN0aXZhdGUodGhpcy5hY3RpdmF0aW9uRnVuY3Rpb25zKTtcbiAgICAgIH1cbiAgICAgIC8vcmV0cmlldmUgb3V0cHV0IG5ldXJvbiB2YWx1ZVxuICAgICAgcmV0LnB1c2godGhpcy5vdXRwdXRMYXllci5uZXVyb25zVmFsdWUpO1xuICAgICAgXG4gICAgfVxuICAgIHJldHVybiByZXQ7XG4gICAgXG4gIH1cblxuICBwdWJsaWMgY29zdCAoZGF0YTogSVRyYWluaW5nRGF0YSk6IG51bWJlciB7XG5cbiAgICBsZXQgeUhhdHMgPSB0aGlzLmZvcndhcmQoZGF0YSksXG4gICAgICAgIGo6IG51bWJlciA9IDAsXG4gICAgICAgIHdlaWdodHNTdW0gPSAwO1xuICAgIFxuICAgIGZvciAobGV0IGsgPSAwOyBrIDwgZGF0YS5sZW5ndGg7IGsrKykge1xuICAgICAgaiArPSB0aGlzLmNvc3RTdHJhdGVneS5mbihkYXRhW2tdLm91dHB1dCwgeUhhdHNba10pO1xuICAgIH1cbiAgICBcbiAgICBqID0gaiAvIGRhdGEubGVuZ3RoO1xuICAgIFxuICAgIHRoaXMuZm9yRWFjaFN5bmFwc2UoKHMpID0+IHtcbiAgICAgIHdlaWdodHNTdW0gKz0gTWF0aC5wb3cocy53ZWlnaHQsIDIpO1xuICAgIH0pO1xuICAgIFxuICAgIGogKz0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLnJlZ3VsYXJpemF0aW9uIC8gKDIgKiBkYXRhLmxlbmd0aCkgKiB3ZWlnaHRzU3VtO1xuICAgIFxuICAgIHJldHVybiBqO1xuIFxuICB9XG5cbiAgcHVibGljIGJhY2t3YXJkIChkYXRhOiBJVHJhaW5pbmdEYXRhKTogSVN5bmFwc2VzTGF5ZXJbXSB7XG5cbiAgICBsZXQgcmV0ID0gW107XG5cbiAgICBmb3IgKGxldCBrID0gMCA7IGsgPCBkYXRhLmxlbmd0aCA7IGsgKysgKSB7XG4gICAgICBcbiAgICAgIGxldCB0dXBsZSA9IGRhdGFba10sXG4gICAgICAgICAgeUhhdCA9IHRoaXMuZm9yd2FyZChbdHVwbGVdKVswXTtcblxuICAgICAgLy9zZXQgdGhlIGlucHV0IGFuZCBvdXRwdXQgbGF5ZXIgdmFsdWVcbiAgICAgIHRoaXMuaW5wdXRMYXllci5uZXVyb25zVmFsdWUgPSB0dXBsZS5pbnB1dDtcbiAgICAgIHRoaXMub3V0cHV0TGF5ZXIubmV1cm9uc1ZhbHVlID0gc3ViKHlIYXQsIHR1cGxlLm91dHB1dCk7XG4gICAgICAvL2NvbXB1dGUgcHJvcGFnYXRpb24gZXJyb3JzIGZvciBhbGwgbGF5ZXJzIGV4cGVjdCBpbnB1dFxuICAgICAgZm9yIChsZXQgaSA9IHRoaXMubmV1cm9uc0xheWVycy5sZW5ndGggLSAxIDsgaSA+PSAxIDsgaS0tKSB7XG4gICAgICAgIHRoaXMubmV1cm9uc0xheWVyc1tpXS5jb21wdXRlRXJyb3JzKHRoaXMuY29zdFN0cmF0ZWd5KTtcbiAgICAgIH1cbiAgICAgIC8vY29tcHV0ZSBkSmRXIGZvciBhbGwgc3luYXBzZXMgbGF5ZXJcbiAgICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHRoaXMubmV1cm9uc0xheWVycy5sZW5ndGggIDsgaSsrKSB7XG4gICAgICAgIHRoaXMubmV1cm9uc0xheWVyc1tpXS5jb21wdXRlR3JhZGllbnRzKCk7XG4gICAgICB9XG5cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHRoaXMuc3luYXBzZXNMYXllcnM7XG5cbiAgfVxuXG4gIHB1YmxpYyBhZGp1c3RXZWlnaHRzIChzeW5hcHNlczogSVN5bmFwc2VzTGF5ZXJbXSwgYmF0Y2hTaXplOiBudW1iZXIsIGRhdGFTaXplOiBudW1iZXIpIHtcblxuICAgIGlmIChzeW5hcHNlcy5sZW5ndGggIT09IHRoaXMuc3luYXBzZXNMYXllcnMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBudW1iZXIgb2Ygc3luYXBzZXMgbGF5ZXJzIGRpZmZlcnMuYCk7XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3luYXBzZXMubGVuZ3RoIDsgaSsrKSB7XG4gICAgICBpZiAoc3luYXBzZXNbaV0ubGVuZ3RoICE9PSB0aGlzLnN5bmFwc2VzTGF5ZXJzW2ldLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBudW1iZXIgb2Ygc3luYXBzZXMgaW4gdGhlICR7aX0gbGF5ZXIgZGlmZmVyc2ApO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICB0aGlzLmZvckVhY2hTeW5hcHNlKChzKSA9PiB7XG4gICAgICBzLndlaWdodCA9ICgxIC0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSAqIHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5yZWd1bGFyaXphdGlvbiAvIGRhdGFTaXplKSAqIHMud2VpZ2h0IC0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxlYXJuaW5nUmF0ZSAvIGJhdGNoU2l6ZSAqIHMuZ3JhZGllbnQ7XG4gICAgICBzLmdyYWRpZW50ID0gMDtcbiAgICB9KTtcbiAgICBcbiAgfVxuICBcbiAgcHVibGljIHRyYWluIChkYXRhOiBJVHJhaW5pbmdEYXRhLCBvcHRpb25zPzogSVRyYWluaW5nQ29uZmlndXJhdGlvbik6IElUcmFpbmluZ091dHB1dCB7XG4gICAgXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLmNvbmZpZy50cmFpbmluZ09wdGlvbnMsIG9wdGlvbnMpO1xuICAgIFxuICAgIGxldCBpdGVyYXRpb25zID0gdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLml0ZXJhdGlvbnMsXG4gICAgICAgIGJhdGNoU2l6ZSA9IHRoaXMuY29uZmlnLnRyYWluaW5nT3B0aW9ucy5iYXRjaFNpemUgPSAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmJhdGNoU2l6ZSA+IGRhdGEubGVuZ3RoKSA/IGRhdGEubGVuZ3RoIDogdGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmJhdGNoU2l6ZTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBpdGVyYXRpb25zIDsgaSsrKSB7XG4gICAgICBcbiAgICAgIGlmIChiYXRjaFNpemUgJiYgYmF0Y2hTaXplICE9PSBkYXRhLmxlbmd0aCkge1xuICAgICAgICBzaHVmZmxlKGRhdGEpO1xuICAgICAgfVxuICAgICAgXG4gICAgICBsZXQgYmF0Y2ggPSBkYXRhLnNsaWNlKDAsIGJhdGNoU2l6ZSksIFxuICAgICAgICAgIHN5bmFwc2VzID0gdGhpcy5iYWNrd2FyZChiYXRjaCk7XG4gICAgICAgICAgXG4gICAgICB0aGlzLmFkanVzdFdlaWdodHMoc3luYXBzZXMsIGJhdGNoU2l6ZSwgZGF0YS5sZW5ndGgpO1xuICAgICAgXG4gICAgICBpZiAodGhpcy5jb25maWcudHJhaW5pbmdPcHRpb25zLmxvZyAmJiBpICUgMiA9PT0gMCkge1xuICAgICAgICBjb25zb2xlLmluZm8oYFByb2dyZXNzICR7aSAvIGl0ZXJhdGlvbnN9LCBjb3N0OiAke3RoaXMuY29zdChkYXRhKX1gKTtcbiAgICAgIH1cbiAgICBcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGVycm9yOiB0aGlzLmNvc3QoZGF0YSlcbiAgICB9O1xuICAgIFxuICB9XG4gIFxufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZU51bWVyaWNhbEdyYWRpZW50cyAobjogTmV1cmFsTmV0d29yaywgZGF0YTogSVRyYWluaW5nRGF0YSkge1xuXG4gIGxldCBlcHNpbG9uID0gMWUtNCxcbiAgICAgIGluaXRpYWxXZWlnaHRzOiBudW1iZXJbXSA9IG4ud2VpZ2h0cyxcbiAgICAgIG51bUdyYWRzID0gaW5pdGlhbFdlaWdodHMubGVuZ3RoLFxuICAgICAgZ3JhZGllbnRzOiBudW1iZXJbXSA9IHplcm9zKG51bUdyYWRzKSxcbiAgICAgIHBlcnR1cmI6IEFycmF5PG51bWJlcj4gPSB6ZXJvcyhudW1HcmFkcyksXG4gICAgICBrO1xuICAgIFxuICBmb3IgKGsgPSAwOyBrIDwgbnVtR3JhZHM7IGsrKykge1xuXG4gICAgbGV0IGxvc3MxLCBsb3NzMjtcblxuICAgIHBlcnR1cmJba10gPSBlcHNpbG9uO1xuICAgIG4ud2VpZ2h0cyA9IGFkZChpbml0aWFsV2VpZ2h0cywgcGVydHVyYik7XG4gICAgbG9zczIgPSBuLmNvc3QoZGF0YSk7XG4gICAgbi53ZWlnaHRzID0gc3ViKGluaXRpYWxXZWlnaHRzLCBwZXJ0dXJiKTtcbiAgICBsb3NzMSA9IG4uY29zdChkYXRhKVxuICAgIGdyYWRpZW50c1trXSA9IGRhdGEubGVuZ3RoICogc3VtKG11bHRpcGx5QnlTY2FsYXIoc3ViKFtsb3NzMl0sIFtsb3NzMV0pLCAxIC8gKGVwc2lsb24gKiAyKSkpO1xuICAgIHBlcnR1cmJba10gPSAwO1xuXG4gIH1cbiAgbi53ZWlnaHRzID0gaW5pdGlhbFdlaWdodHM7XG4gIHJldHVybiBncmFkaWVudHM7XG5cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==